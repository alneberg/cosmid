#!/usr/bin/env python

"""Cosmid CLI

Usage:
  cosmid clone [<resource_id>...] [--save] [--dry]
  cosmid update [<resource_id>...]
  cosmid search <query>
  cosmid init
  cosmid (-h | --help)
  cosmid --version

Commands:
  clone               Download a new resource(s) locally
  update              Update local resources to the latest version
  search              Search among the available resources

Arguments:
  <resource_id>       List of resource IDs to clone or update
  <query>             Search term for matching against available resources

Options:
  -h --help           Show this screen
  -v --version        Show version
  -s --save           Add the successfully cloned resources to 'cosmid.yaml'
  -d --dry            Run in dry-mode keeping status quo
"""
from __future__ import print_function

import sys
from docopt import docopt
from path import path

import cosmid
from cosmid.core import Registry
from termcolor import colored


def main(args):
  # Always initiate the registry!
  hub = Registry()

  # -------------------------------------------------------
  #  Search among the available resources
  # -------------------------------------------------------
  if args["search"]:
    # Search the registry using the query
    options = hub.search(args["<query>"])

    # Just to make sure we print something (feedback)
    print("\nSearch results:\n")

    # Print each of the matches (top 5) to the console as updates
    for option in options:
      hub.messenger.send("note", option[0])

  elif args["init"]:
    # Help out with initializing a new project
    # Start by printing a nice welcome message!
    hub.messenger.welcome(cosmid.__version__)

    q = "[{}]".format(colored("?", "green"))

    # Get user email for logging in to some FTP servers
    promt = colored("{} Your email (FTP login): ".format(q), "cyan")
    hub.config.add("email", raw_input(promt))

    # Decide where to store cloned resources
    promt = colored("{} Where to store resources: (resources)".format(q),
                    "cyan")
    hub.config.add("dest", raw_input(promt))

    hub.config.save()

  else:
    # -------------------------------------------------------
    #  Clone some resources!
    #  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    #  N.B. Updating specific resources without version will
    #  replace existing releases with the latest version.
    # -------------------------------------------------------
    # We at least want to warn about not finding the project file
    if not hub.project_path.exists():
      message = "Can't find '{}'.".format(hub.project_path)

      if args["--save"]:
        message_type = "error"
      else:
        message_type = "warning"

      hub.messenger.send(message_type, message)

    # Download resources specified from CLI
    if args["<resource_id>"]:
      resources = {}
      for resource_id in args["<resource_id>"]:
        # I add an extra ``None`` to be able to replace it with "*" for
        # entries without version #-tags that will be only 1-item lists.
        parts = resource_id.split("#") + [None]
        resources[parts[0]] = parts[1] or "latest"

    elif args["update"]:
      # We require the history file
      if not hub.history_path.exists():
        message = "Can't find any cloned any resources."
        hub.messenger.send("error", message)
        sys.exit()

      # Add 'updateable' resources from history-file
      resources = hub.history.updateable()

    else:
      # Download all resources listed in "cosmid.yaml"
      resources = hub.project.find()

    # -------------------------------------------------------
    #  Download each of the resources
    # -------------------------------------------------------
    for resource_id, target in resources.iteritems():

      # Path to actual save location for the resource
      if not hub.dest.exists():
        # Create it!
        hub.dest.mkdir()

      resource, dl_paths, save_paths = hub.grab(resource_id, target)

      if resource is None:
        # Something didn't add up... the user has been notified.
        continue

      else:
        # Path to actual save location for the resource
        folder = path("{dest}/{id}".format(dest=hub.dest, id=resource.id))
        if not folder.exists() and not args["--dry"]:
          # Create it!
          folder.mkdir()

        # Download each file belonging to the resource
        for dl_path, save_path in zip(dl_paths, save_paths):
          if args["--dry"]:
            message = "Cloning: '{0}' to '{1}'".format(dl_path, save_path)
            hub.messenger.send("ghost", message)

          else:
            # Prepare the user for what is going to happen
            fileSize = resource.ftp.fileSize(dl_path)
            message = ("Downloading: {path} - {size} MB"
                       .format(path=save_path, size=fileSize))

            hub.messenger.send("update", message)

            # Commit to the download!
            resource.ftp.commit(dl_path, save_path)

        if args["--save"] or args["update"]:
          # Add the user supplied data to the project YAML file
          hub.project.add(resource_id, target)

    if not args["--dry"]:
      # Save over the old "cosmid.yaml" file
      hub.project.save()
      hub.history.save()

if __name__ == "__main__":
    args = docopt(__doc__, version="cosmid {v}".format(v=cosmid.__version__))
    main(args)
